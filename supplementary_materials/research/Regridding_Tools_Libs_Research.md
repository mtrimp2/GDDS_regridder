# Regridding Tools & Libraries Research Documentation
Author: Maggie Trimpin
ver 4.
Updated 4-8-22

---
## What is it?
Regridding is the process of interpolating from one grid resolution to a different grid resolution. This could involve temporal, vertical or spatial ('horizontal') interpolations. However, most commonly, regridding refers to spatial interpolation.


## Why Regrid Data?
Geospatial gridded datasets (climate models, remote sensing images, etc.) frequency exist on dissimilar grids. Regridding is a method of combining various gridded datasets on one plot

Grids used in climate research fall into several categories: regular, rectilinear, curvilinear and unstructured. Grids described by one-dimensional latitude and longitude coordinates ([*]) will be called rectilinear; grids where the coordinates are two-dimensional ([*][*]) will be called curvilinear; and, grids in which the grid coordinates require a list of nodes (connectivity information) will be called unstructured.

## Regridding Options
### **Coordinate Systems**
+ Cartesian: Sometimes used for small regional grids. Coordinates expressed in terms of distance (e.g. x,y)
+ Spherical: The standard spherical Earth representation. Coordinates expressed in angles. (e.g. longitude, latitude)

### **Grid Types**
+ Grid/logically rectangular: A grid whose points could be stored in a rectangular index space, or a set of rectangular index spaces. Also sometimes called a structured grid. Examples of this type of grid include a regular latitude-longitude grid, and a cubed sphere grid. ESMF currently supports 2D or 3D logically rectangular grids:
  + 2D: These grids consist entirely of quadrilaterals.
  + 3D: These grids consist entirely of hexahedrons.

+ Mesh/unstructured: A superset of logically rectangular grids consisting of cells with possibly different numbers of sides connected together. An example of this is a grid with triangular cells. ESMF currently supports 2D or 3D meshes:
  + 2D: ESMF supports meshes containing polygons with any number of sides (e.g. triangles, quadrilaterals, pentagons,â€¦). Polygons with more than four sides are represented internally as a set of triangles, but to the user should behave as if they are a single polygon.
  + 3D: ESMF supports meshes containing hexahedrons and tetrahedrons.
+ LocStream/location stream: A set of disconnected points. This option is useful for representing the locations of data where there is no inherent structure connecting the points into cells (e.g. a set of scattered observations). Because of the lack of cell structure, location streams are not appropriate as the source and destination for every regrid method.

### **Regridding Methods/ Interpolations**
1. **bilinear**: Linear interpolation on a 2 dimensional, rectilinear grid. Performed using linear interpolation first in one direction, and then again in the other direction.
2. **nearest neighbor**: Multivariate interpolation in one or more dimensions. The nearest neighbor algorithm selects the value of the nearest point and does not consider the values of neighboring points at all, yielding a piecewise-constant interpolant.
3. **source to destination**: Each destination point is mapped to the closest source point. A source point can be mapped to multiple destination points. Some source points may not be mapped.
4. **destination to source**: Each source point is mapped to the closest destination point. A destination point can be mapped to multiple source points, in which case the destination is the sum 

5. **First-order conservative**: Preserves the integral of the source field across the regridding. For this method, weight calculation is based on the ratio of source cell area overlapped with the corresponding destination cell area. The user areas option allows the user to adjust the interpolation weights so that conservation is based on user-supplied areas.

6. **Second-order conservative**: Like first-order conservative, this method preserves the integral of the source field across the regridding. Also like the first-order, weight calculation is based on the ratio of source cell area overlapped with the corresponding destination cell area, and allows the user to provide their own areas if desired. However, the second-order conservative calculation also includes the gradient across the source cell, so in general it gives a smoother, more accurate representation of the source field. This is particularly true when going from a coarse to finer grid.

7. **inverse distance**: A type of deterministic method for multivariate interpolation with a known scattered set of points. The assigned values to unknown points are calculated with a weighted average of the values available at the known points.

8. **spline**: A form of interpolation where the interpolant is a special type of piecewise polynomial called a spline. That is, instead of fitting a single, high-degree polynomial to all of the values at once, spline interpolation fits low-degree polynomials to small subsets of the values, for example, fitting nine cubic polynomials between each of the pairs of ten points, instead of fitting a single degree-ten polynomial to all of them.

9. **Inverse Distance to a Power**: A Weighted average interpolator. You should supply the input arrays with the scattered data values including coordinates of every data point and output grid geometry. The function will compute interpolated value for the given position in output grid.

10. **Moving Average**: A simple data averaging algorithm. It uses a moving window of elliptic form to search values and averages all data points within the window. Search Ellipse can be rotated by specified angle, the center of ellipse located at the grid node. Also the minimum number of data points to average can be set, if there are not enough points in window, the grid node considered empty and will be filled with specified NODATA value.

---

## Available Tools and Libraries
Note: Tools are listed alphabetically. Ordering of the tools does not reflect heirarchy of use/ priority.
+ **CDO** [documentation](https://code.mpimet.mpg.de/projects/cdo/wiki/Cdo#Documentation): The Climate Data Operators (CDO) is a large tool set for working on climate and Numerical Weather Prediction (NWP) model data. CDO can also be used to analyse any kind of gridded data not related to climate science.
+ **Cf-python** [documentation](https://ncas-cms.github.io/cf-python/): Provides basic functionality for regridding onto a new latitude-longitude grid. By default the interpolation is first-order conservative, but bilinear interpolation is also possible. The missing data masks of the field and the new grid are aslo taken into account.
+ **ESMPy** [documentation](https://earthsystemmodeling.org/esmpy/): Python interface to the Earth System Modeling Framework (ESMF) regridding utility. Provides a Grid to represent single-tile logically rectangular coordinate data, a Mesh for unstructured coordinates, and a LocStream for collections of unconnected points like observational data streams. ESMPy supports bilinear, nearest neighbor, higher order patch recovery, first-order conservative and second-order conservative regridding. There is also an option to ignore unmapped destination points and mask out points on either the source or destination.
  + **ESMF** [documentation](https://earthsystemmodeling.org/doc/) (accessed through ESMPy, or via command line): Two command line appliations are installed with ESMF to generate and optionally apply interpolation weights from the command line using NetCDF files. These applications are ESMF_RegridWeightGen, which generates interpolation weights and ESMF_Regrid, which generates and applies interpolation weights.
+ **GDAL** [documentation](https://gdal.org/): GDAL is a translator library for raster and vector geospatial data formats that is released under an X/MIT style Open Source License by the Open Source Geospatial Foundation. As a library, it presents a single raster abstract data model and single vector abstract data model to the calling application for all supported formats. It also comes with a variety of useful command line utilities for data translation and processing. 
+ **NCL** [documentation](https://www.ncl.ucar.edu/Applications/ESMF.shtml): Another method of regridding using ESMF software. ESMF regridding in NCL can be done one of three ways; each method has its advantages:
  + Via a single call to the function ESMF_regrid 
  + Via a call to the function ESMF_regrid_with_weights - this method is straight-forward and faster; it requires that you already have the weights file. You can use the weights file generated from an initial call to ESMF_regrid.
  + Via a multi-step process - this method is the most complicated, but allows for individual control over all the regridding steps. This method is not really recommended, unless you understand the multi-step regridding process well. 
+ **NCO** [documentation](http://nco.sourceforge.net/): The netCDF Operators (NCO) software tool- automatically remaps data expressed in diverse formats onto different grids. NCO algorithms automatically identify the relevant grids, choose the appropriate mathematical options, and accurately remap the data with a single command. Though primarily for use in the command line, NCO offers a Python library, pyNCO, that can carry out NCO's command line processes within a python file. 
+ **ncoToolkit** [documentation](https://nctoolkit.readthedocs.io/en/latest/index.html): Fast and easy analysis of netCDF data in Python; works with the netcdf4 library and data objects. nctoolkit.DataSet.to_latlon and nctoolkit.DataSet.regrid are two functions that support regridding to a variety of different grids, based on lat/lon upper and lower limits. Resolutions must also be specified. Methods available include bilinear, nearest neighbor, bicubic, distance-weighted average, First order conservative remapping, Second order conservative remapping, and Large area fraction remapping 
+ **pyresample** [documentation](https://pyresample.readthedocs.io/en/latest/): Pyresample is a python package for resampling geospatial image data. It is the primary method for resampling in the SatPy library, but can also be used as a standalone library. Resampling or reprojection is the process of mapping input geolocated data points to a new target geographic projection and area. Supports bilinear, Nearest Neighbor, Elliptical Weighted Average, and bucket resampling. 
+ **xESMF** [documentation](https://xesmf.readthedocs.io/en/latest/): Uses ESMF/ESMPy as backend and can regrid between general curvilinear grids with all ESMF regridding algorithms, such as bilinear, conservative and nearest neighbour. Compatible with xarray datasets and functionalities. 


## Tool Comparison Table (updated 4-8-22)
| Tool        |   Interpolations Supported  | Pros| Cons |
| :------- | :----------: | :----------: | :----------: | 
|**CDO**      |  <ul><li>bilinear</li><li>nearest neighbor</li><li>first-order conservative</li> <li>distance</li><li>bicubic</li> </ul>         | <ul><li>More than 700 operators available<li>Modular design and easily extendable with new operators<li>Very simple UNIX command line interface<li>A dataset can be processed by several operators, without storing the interim results in files<li>Most operators handle datasets with missing values<li>Fast processing of large datasets<li>Support of many different grid types<li>Tested on many UNIX/Linux systems, Cygwin, and MacOS-X</ul>|Command line only|
|  **Cf-python**  |   <ul><li>bilinear</li><li>first-order conservative</li><li>Higher order patch recovery<li>nearest neighbor (stod and dtos)</ul>     | <ul><li>Based on the Earth System Modeling Framework (ESMF) library<li>Spherical (regrids) or Cartesian (regridc)<li>Global or regional grids in any combination<li>Grids with 2D latitudes and longitudes including some tripolar<li>Handles masking of both source and destination</ul> |<ul><li>Limited to just python<li>Unable to process non-CF-compliant datasets|
|   **ESMPy**     |   <ul><li>bilinear</li><li>patch</li><li>first-order conservative</li><li>second-order conservative</li><li>nearest neighbor (stod and dtos)</li></ul>| <ul><li>Based on the Earth System Modeling Framework (ESMF) library- Enables ESMF regridding to be used with very little effort, in an object oriented way<li> Numpy array access to distributed data<li>Enables ESMF regridding to be used in other scientific packages with python-based workflows |<ul><li>Limited to python<li>ESMPy doesnâ€™t include many aspects of ESMF, including components, array interfaces, time management, etc.<li>There is no support for tripole or multi-tile Grids.<li>ESMPy cannot use an ESMF installation that is built with external LAPACK support.<li>Conservative regridding with a source Mesh created from file is not supported, because the Mesh cannot retrieve coordinates from the elements.<li>only spherical coordinate systems are supported |
|**GDAL**      |  <ul><li>bilinear</li><li>nearest neighbor</li><li>spline</li><li>cubic</li> </ul>        |<ul><li>Stable with ongoing maintenance<li>Bindings for a lot of the mainstream languages (C#, Python, Java, Perl, among others)<li>Compatible with numpy<li> Can create raster models from input data | <ul><li>Exclusively 2D, no convenience for layers, time. Reprojecting becomes rather costly, since it recomputes weights for every slice<li>Resampling methods are purely based on cell centers, no true evaluation of areal overlap</ul>
|**NCL**      |  <ul><li>bilinear</li><li>nearest neighbor (stod and dtos)</li><li>first-order conservative</li> <li>patch </ul>         |  <ul><li>Supports rectilinear, curvilinear, and unstructured grids<li> Allow regridding from rectilinear grids to curvilinear grids, and curvilinear grids to rectilinear grids<li>Based on the Earth System Modeling Framework (ESMF) library<li> |<ul><li>Only supports a few ESMF regridding functions; Very limited <li>masking needs to be done before weight calculation so the regridding knows what it should ignore|
|**NCO**      |   <ul><li>bilinear</li>  <li>nearest neighbor</li><li>first-order conservative</li> <li>spline</li> </ul>    |  <ul><li>Versatile in input/output format (take netCDF, HDF, and/or DAP files as input, output the results to screen or files in text, binary, or netCDF formats)<li> shell-command style of NCO allows users to manipulate and analyze files interactively, or with expressive scripts that avoid some overhead of higher-level programming environments<li>Many pre-built Executables |<ul><li>Command line only| 
|**ncoToolkit** |  <ul><li>bilinear</li>  <li>nearest neighbor</li><li>first-order conservative</li><li>second-order conservative</li> <li>bicubic</li> <li>large-area fraction remapping</li></ul> | <ul><li>Very versatile; many interpolations supported</li><li>Useful for Calculating anomalies, Horizontally and vertically remapping data</li><li> able to open datasets locally or via url</li><li> Compatible with pandas dataframes</li><li> Able to easiy create nctoolkit dataset objets from netcdf files </li><li> can easily convert nctoolkit datasets to xarray/pandas datasets </li><li>Uses CDO as backend</li></ul> | Only for  Linux and macOS |
|  **pyresample**  |  <ul><li>bilinear<li> nearest neighbor <li>Elliptical Weighted Average (EWA)<li>Bucket resampling (count hits per bin, averaging, ratios)  |<ul><li>can operate on both fixed grids of data and geolocated swath data<li>Works with numpy arrays and numpy masked arrays<li>Interfaces to XArray objects (including dask array support) are provided in separate Resampler class interfaces<li>Parallel computation support |<ul><li>limited interpolations<li>Primary method for resampling in the SatPy library, but can also be used as a standalone library 
|  **xESMF**  |    <ul><li>bilinear</li><li>nearest neighbor</li><li>first-order conservative</li> </ul>     | <ul><li>Compatible with xarray datasets<li>provides an easy frontend for ESMF regridder</ul>|<ul><li>Still many ESMF functions not accessible through xESMF<li>Limitations with global regridding<li> data model can only describe quadrilateral grids; Limited with irregular meshes <li>Only available for Mac and Linux, windows users must use wsl |
| **xarray** |<ul><li>bilinear<li>cubic<li>nearest neighbor<li>spline</ul>  | <ul><li>Built-in xarray method |<ul><li>Slightly primitive- not a lot of customizability options</ul>
